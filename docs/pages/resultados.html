<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resultados - Infer√™ncia Geoespacial</title>    <link rel="icon" type="image/svg+xml" href="../favicon.svg">    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../libs/leaflet/leaflet.css">
    <script src="../libs/chartjs/chart.umd.min.js"></script>
    <script src="../libs/leaflet/leaflet.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1 class="header-title">
                <span class="icon icon-map"></span>
                Infer√™ncia Geoespacial Aplicada √† Gera√ß√£o de Base Vetorial Rodovi√°ria: Estudo de Caso para o Estado de S√£o Paulo
            </h1>
            <p class="header-subtitle">Base estimada: Malha municipal estimada - PLI/SP (OSM + DER/SP + SEADE)</p>
        </div>
    </header>

    <nav class="nav">
        <div class="nav-container">
            <ul class="nav-list">
                <li class="nav-item"><a href="../index.html" class="nav-link">In√≠cio</a></li>
                <li class="nav-item"><a href="metodologia-silvio.html" class="nav-link">Metodologia</a></li>
                <li class="nav-item"><a href="dados.html" class="nav-link">Dados</a></li>
                <li class="nav-item"><a href="resultados.html" class="nav-link active">Resultados</a></li>
                <li class="nav-item"><a href="mapas.html" class="nav-link">Mapas</a></li>
                <li class="nav-item"><a href="pesquisa-municipal.html" class="nav-link">Pesquisa Municipal</a></li>
            </ul>
        </div>
    </nav>

    <script src="../js/main.js"></script>
    <script>
        // Carrega Chart.js localmente e faz fallback para CDN se necess√°rio, depois desenha os gr√°ficos
        function loadChartAndRender(renderFn) {
            if (window.Chart) {
                renderFn();
                return;
            }
            const localScript = document.createElement('script');
            localScript.src = '../libs/chartjs/chart.umd.min.js';
            localScript.onload = renderFn;
            localScript.onerror = () => {
                const cdnScript = document.createElement('script');
                cdnScript.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js';
                cdnScript.onload = renderFn;
                document.head.appendChild(cdnScript);
            };
            document.head.appendChild(localScript);
        }

        function renderCharts() {
            if (!window.Chart) return;
            // Configura√ß√µes globais do Chart.js
            Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            Chart.defaults.font.size = 14;
            
            // Configura√ß√£o comum para legendas na parte inferior
            const legendConfig = {
                display: true,
                position: 'bottom',
                align: 'center',
                labels: {
                    padding: 15,
                    usePointStyle: true,
                    font: { size: 12 }
                }
            };
            
            // Gr√°fico 1: Distribui√ß√£o OSM por Faixa de Extens√£o
            const ctxOSM = document.getElementById('chartDistribuicaoOSM');
            if (ctxOSM) {
                new Chart(ctxOSM.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['0-50 km', '50-100 km', '100-200 km', '200-400 km', '> 400 km'],
                        datasets: [{
                            label: 'N√∫mero de Munic√≠pios',
                            data: [85, 142, 198, 156, 64],
                            backgroundColor: 'rgba(0, 102, 204, 0.7)',
                            borderColor: 'rgba(0, 102, 204, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Distribui√ß√£o de Munic√≠pios por Faixa de Extens√£o - OSM',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: legendConfig,
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const extensoes = [3400, 10650, 29700, 46800, 31693];
                                        const percentuais = ['13.2%', '22.0%', '30.7%', '24.2%', '9.9%'];
                                        return [`Extens√£o: ~${extensoes[context.dataIndex].toLocaleString('pt-BR')} km`, 
                                                `Percentual: ${percentuais[context.dataIndex]}`];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Quantidade de Munic√≠pios' }
                            },
                            x: {
                                title: { display: true, text: 'Faixa de Extens√£o' }
                            }
                        }
                    }
                });
            }

            // Gr√°fico 2: Distribui√ß√£o DER por Faixa
            const ctxDER = document.getElementById('chartDistribuicaoDER');
            if (ctxDER) {
                new Chart(ctxDER.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['0-50 km', '50-100 km', '100-200 km', '200-400 km', '> 400 km'],
                        datasets: [{
                            label: 'N√∫mero de Munic√≠pios',
                            data: [412, 158, 52, 14, 1],
                            backgroundColor: 'rgba(255, 102, 0, 0.7)',
                            borderColor: 'rgba(255, 102, 0, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Distribui√ß√£o de Munic√≠pios por Faixa de Extens√£o - DER',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: legendConfig,
                            tooltip: {
                                callbacks: {
                                    afterLabel: function(context) {
                                        const extensoes = [12360, 11850, 7800, 4200, 409];
                                        const percentuais = ['64.7%', '24.8%', '8.2%', '2.2%', '0.2%'];
                                        return [`Extens√£o: ~${extensoes[context.dataIndex].toLocaleString('pt-BR')} km`, 
                                                `Percentual: ${percentuais[context.dataIndex]}`];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Quantidade de Munic√≠pios' }
                            },
                            x: {
                                title: { display: true, text: 'Faixa de Extens√£o' }
                            }
                        }
                    }
                });
            }

            // Gr√°fico 3: Compara√ß√£o Geral OSM vs DER
            const ctxComp = document.getElementById('chartComparacaoGeral');
            if (ctxComp) {
                new Chart(ctxComp.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['Extens√£o Total (km)', 'Munic√≠pios', 'M√©dia/Munic√≠pio (km)', 'Densidade (km/10.000km¬≤)'],
                        datasets: [{
                            label: 'OSM',
                            data: [122243, 645, 189.5, 4920],
                            backgroundColor: 'rgba(0, 102, 204, 0.7)',
                            borderColor: 'rgba(0, 102, 204, 1)',
                            borderWidth: 2
                        }, {
                            label: 'DER',
                            data: [25919, 637, 40.7, 1040],
                            backgroundColor: 'rgba(255, 102, 0, 0.7)',
                            borderColor: 'rgba(255, 102, 0, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Compara√ß√£o de M√©tricas: OSM vs DER',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: legendConfig
                        },
                        scales: {
                            y: {
                                type: 'logarithmic',
                                title: { display: true, text: 'Valor (escala logar√≠tmica)' }
                            },
                            x: {
                                title: { display: true, text: 'M√©trica' }
                            }
                        }
                    }
                });
            }

            // Gr√°fico 4: Distribui√ß√£o Comparada por Faixa
            const ctxCompFaixa = document.getElementById('chartDistribuicaoComparada');
            if (ctxCompFaixa) {
                new Chart(ctxCompFaixa.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['0-50 km', '50-100 km', '100-200 km', '200-400 km', '> 400 km'],
                        datasets: [{
                            label: 'OSM',
                            data: [85, 142, 198, 156, 64],
                            backgroundColor: 'rgba(0, 102, 204, 0.7)',
                            borderColor: 'rgba(0, 102, 204, 1)',
                            borderWidth: 2
                        }, {
                            label: 'DER',
                            data: [412, 158, 52, 14, 1],
                            backgroundColor: 'rgba(255, 102, 0, 0.7)',
                            borderColor: 'rgba(255, 102, 0, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Compara√ß√£o de Distribui√ß√£o por Faixa: OSM vs DER',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: legendConfig
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Quantidade de Munic√≠pios' }
                            },
                            x: {
                                title: { display: true, text: 'Faixa de Extens√£o' }
                            }
                        }
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadChartAndRender(renderCharts);
        });
    </script>
    <main class="main-content">
                <h3 class="section-subtitle mt-2">üìà Distribui√ß√£o por Faixa de Extens√£o</h3>
                <div class="chart-container chart-wrapper">
                    <canvas id="chartDistribuicaoDER"></canvas>
                </div>

                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Observa√ß√£o:</strong> <strong>64,7% dos munic√≠pios</strong> t√™m menos de 50 km de vicinais cadastradas no DER, indicando cobertura concentrada em poucos munic√≠pios ou subnotifica√ß√£o generalizada.
                </div>
            </div>

            <!-- Q2: CONCESS√ïES DER (N/A) -->
            <div class="section mt-2">
                <h2 class="section-title">Q2. Qual a participa√ß√£o das concess√µes na malha vicinal DER?</h2>
                <div class="alert alert-secondary">
                    <strong>‚ö†Ô∏è N√£o aplic√°vel:</strong> Estradas vicinais municipais n√£o fazem parte do regime de concess√µes estaduais.
                </div>
            </div>

            <!-- Q3: URBANO/RURAL DER -->
            <div class="section mt-2">
                <h2 class="section-title">Q3. Como as vicinais DER se distribuem entre √°reas urbanas e rurais?</h2>
                <p class="section-subtitle">Classifica√ß√£o baseada nas manchas urbanas do IBGE (2019)</p>

                <div class="stats-container">
                    <div class="stat-box bg-green-light">
                        <span class="stat-label">√Årea Rural</span>
                        <span class="stat-value">~22.030 <span class="stat-unit">(km)</span></span>
                        <span class="stat-info">85% do total DER</span>
                    </div>
                    <div class="stat-box bg-red-light">
                        <span class="stat-label">√Årea Urbana</span>
                        <span class="stat-value">~2.590 <span class="stat-unit">(km)</span></span>
                        <span class="stat-info">10% do total DER</span>
                    </div>
                    <div class="stat-box bg-orange-light">
                        <span class="stat-label">√Årea Mista</span>
                        <span class="stat-value">~1.300 <span class="stat-unit">(km)</span></span>
                        <span class="stat-info">5% do total DER</span>
                    </div>
                </div>

                <div class="alert alert-info">
                    <strong>üí° Interpreta√ß√£o:</strong> A propor√ß√£o rural/urbana da malha DER √© similar √† OSM (85% rural), confirmando a natureza rural das vicinais cadastradas.
                </div>
            </div>

            <!-- Q4: ACESSIBILIDADE DER -->
            <div class="section mt-2">
                <h2 class="section-title">Q4. Qual o n√≠vel de acessibilidade rodovi√°ria DER para a popula√ß√£o?</h2>
                <p class="section-subtitle">Tr√™s m√©tricas complementares</p>

                <div class="stats-container">
                    <div class="stat-box bg-orange-light">
                        <span class="stat-label">Extens√£o Total DER</span>
                        <span class="stat-value">25.919 <span class="stat-unit">(km)</span></span>
                        <span class="stat-info">Cadastro oficial estadual</span>
                    </div>
                    <div class="stat-box bg-orange-light">
                        <span class="stat-label">Densidade por √Årea</span>
                        <span class="stat-value">1.040 <span class="stat-unit">(km/10.000km¬≤)</span></span>
                        <span class="stat-info">M√©dia estadual | M√°x: 2.850</span>
                    </div>
                    <div class="stat-box bg-orange-light">
                        <span class="stat-label">Disponibilidade por Habitante</span>
                        <span class="stat-value">5,6 <span class="stat-unit">(km/10.000hab)</span></span>
                        <span class="stat-info">M√©dia estadual | M√°x: 312</span>
                    </div>
                </div>

                <div class="alert alert-danger mt-2">
                    <strong>‚ö†Ô∏è Gap de Acessibilidade:</strong> Com densidade 4,7√ó menor que OSM, o cadastro DER representa apenas <strong>21% da infraestrutura vicinal real</strong>, sugerindo grande volume de estradas municipais n√£o oficializadas ou n√£o cadastradas no sistema estadual.
                </div>
            </div>

            <!-- Q5: HIERARQUIA DER (N/A) -->
            <div class="section mt-2">
                <h2 class="section-title">Q5. Como se estrutura a hierarquia da malha vicinal DER?</h2>
                <div class="alert alert-secondary">
                    <strong>‚ö†Ô∏è Limitado:</strong> Vicinais municipais n√£o possuem hierarquia funcional formal como SP/SPA/SPI/BR do sistema rodovi√°rio estadual.
                </div>
            </div>

            <!-- Q6: DISPARIDADES REGIONAIS DER -->
            <div class="section mt-2">
                <h2 class="section-title">Q6. Existem disparidades regionais significativas na malha DER?</h2>
                <p class="section-subtitle">An√°lise do desvio em rela√ß√£o √† m√©dia estadual (0,104 km/km¬≤)</p>

                <div class="stats-container">
                    <div class="stat-box bg-green-light">
                        <span class="stat-label">Munic√≠pios Acima da M√©dia</span>
                        <span class="stat-value">142</span>
                        <span class="stat-info">22% do total (637 munic√≠pios)</span>
                    </div>
                    <div class="stat-box bg-red-light">
                        <span class="stat-label">Munic√≠pios Abaixo da M√©dia</span>
                        <span class="stat-value">495</span>
                        <span class="stat-info">78% do total (637 munic√≠pios)</span>
                    </div>
                    <div class="stat-box bg-orange-light">
                        <span class="stat-label">Raz√£o M√°ximo/M√≠nimo</span>
                        <span class="stat-value">2,7 <span class="stat-unit">(√ó)</span></span>
                        <span class="stat-info">Variabilidade regional moderada</span>
                    </div>
                </div>

                <h3 class="section-subtitle mt-2">üìç Destaques Regionais:</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Regi√£o Administrativa</th>
                                <th>Densidade DER (km/1000km¬≤)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-green-light">
                                <td><strong>RMSP</strong></td>
                                <td>167,3</td>
                                <td>üü¢ Muito acima da m√©dia (+61%)</td>
                            </tr>
                            <tr class="bg-green-light">
                                <td><strong>RM de Campinas</strong></td>
                                <td>145,4</td>
                                <td>üü¢ Muito acima da m√©dia (+40%)</td>
                            </tr>
                            <tr>
                                <td><strong>RA de Campinas</strong></td>
                                <td>132,3</td>
                                <td>üü° Acima da m√©dia (+27%)</td>
                            </tr>
                            <tr class="bg-red-light">
                                <td><strong>RA de Registro</strong></td>
                                <td>36,6</td>
                                <td>üî¥ Muito abaixo da m√©dia (-65%)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Interpreta√ß√£o:</strong> Padr√£o regional DER √© <strong>similar ao OSM</strong> (RMSP e Campinas com alta densidade, Registro com baixa), mas com valores absolutos 4-5√ó menores, sugerindo <strong>subnotifica√ß√£o uniforme</strong> em todas as regi√µes.
                </div>
            </div>
        </section>

        <!-- ===================================================================== -->
        <!-- PARTE 3: COMPARA√á√ÉO OSM VS DER -->
        <!-- ===================================================================== -->
        <section class="section mt-2">
            <h1 class="section-title section-title-comparacao">
                üîç PARTE 3: Compara√ß√£o OSM vs DER
            </h1>
            <p class="subtitle-large">An√°lise comparativa das diverg√™ncias e converg√™ncias entre as duas fontes de dados</p>

            <!-- Q1 COMPARADO: DISTRIBUI√á√ÉO -->
            <div class="section mt-2">
                <h2 class="section-title">Q1. Compara√ß√£o da Distribui√ß√£o Territorial</h2>
                
                <div class="chart-container chart-wrapper-large">
                    <canvas id="chartComparacaoGeral"></canvas>
                </div>

                <h3 class="section-subtitle mt-2">üìä Distribui√ß√£o Comparada por Faixa:</h3>
                <div class="chart-container chart-wrapper">
                    <canvas id="chartDistribuicaoComparada"></canvas>
                </div>

                <div class="alert alert-danger">
                    <strong>üö® Diverg√™ncia Cr√≠tica:</strong> DER concentra <strong>65% dos munic√≠pios</strong> na faixa mais baixa (0-50 km), enquanto OSM distribui de forma mais uniforme. Isso indica <strong>subnotifica√ß√£o sistem√°tica</strong> no cadastro oficial, n√£o apenas aus√™ncia de algumas vias.
                </div>
            </div>

            <!-- Q4 COMPARADO: ACESSIBILIDADE -->
            <div class="section mt-2">
                <h2 class="section-title">Q4. Compara√ß√£o de Acessibilidade Rodovi√°ria</h2>
                
                <div class="cards-grid">
                    <div class="card">
                        <h4 class="card-title">Extens√£o Total (km)</h4>
                        <div class="card-content">
                            <div class="metric-value-large">OSM: <strong class="metric-osm-color">122.243 km</strong></div>
                            <div class="metric-value-large">DER: <strong class="metric-der-color">25.919 km</strong></div>
                            <div class="mt-1 bg-red-light gap-box">
                                <strong>Raz√£o: 4,7√ó</strong> | Gap: 96.324 km
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h4 class="card-title">Densidade por √Årea (km/10.000km¬≤)</h4>
                        <div class="card-content">
                            <div class="metric-value-large">OSM: <strong class="metric-osm-color">4.920</strong></div>
                            <div class="metric-value-large">DER: <strong class="metric-der-color">1.040</strong></div>
                            <div class="mt-1 bg-red-light gap-box">
                                <strong>Raz√£o: 4,7√ó</strong> | Gap: 3.880 km/10.000km¬≤
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h4 class="card-title">Disponibilidade (km/10.000hab)</h4>
                        <div class="card-content">
                            <div class="metric-value-large">OSM: <strong class="metric-osm-color">26,3</strong></div>
                            <div class="metric-value-large">DER: <strong class="metric-der-color">5,6</strong></div>
                            <div class="mt-1 bg-red-light gap-box">
                                <strong>Raz√£o: 4,7√ó</strong> | Gap: 20,7 km/10.000hab
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-warning mt-2">
                    <strong>üí° Consist√™ncia:</strong> A raz√£o OSM/DER √© <strong>consistentemente 4,7√ó</strong> nas tr√™s m√©tricas, indicando que a diverg√™ncia √© proporcional e <strong>n√£o devida a outliers ou erros pontuais</strong>, mas sim a uma <strong>diferen√ßa estrutural de cobertura</strong>.
                </div>
            </div>

            <!-- Q6 COMPARADO: DISPARIDADES REGIONAIS -->
            <div class="section mt-2">
                <h2 class="section-title">Q6. Compara√ß√£o de Disparidades Regionais</h2>
                <p class="section-subtitle">An√°lise da raz√£o OSM/DER por Regi√£o Administrativa</p>

                <div class="map-wrapper">
                    <div id="map-ra-divergencia" class="map-container"></div>
                </div>
                <script>
                    // Mapa de diverg√™ncia OSM/DER por Regi√£o Administrativa usando c√≠rculos proporcionais
                    function initRADivergenciaMap() {
                        if (!window.L) return;
                        const mapContainer = document.getElementById('map-ra-divergencia');
                        if (!mapContainer) return;

                        const map = L.map('map-ra-divergencia', { scrollWheelZoom: false });
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; OpenStreetMap contribuidores'
                        }).addTo(map);

                        const raData = [
                            { nome: 'RA de Registro', ratio: 7.1, densOSM: 259.7, densDER: 36.6, coords: [-24.5, -47.84] },
                            { nome: 'RMSP', ratio: 6.2, densOSM: 1034.7, densDER: 167.3, coords: [-23.55, -46.63] },
                            { nome: 'RA de Barretos', ratio: 6.6, densOSM: 588.0, densDER: 89.0, coords: [-20.55, -48.57] },
                            { nome: 'RA de S√£o Jos√© do Rio Preto', ratio: 6.0, densOSM: 559.2, densDER: 92.8, coords: [-20.82, -49.38] },
                            { nome: 'RA de Campinas', ratio: 6.6, densOSM: 870.3, densDER: 132.3, coords: [-22.9, -47.06] },
                            { nome: 'RA de Sorocaba', ratio: 6.2, densOSM: 818.3, densDER: 131.5, coords: [-23.5, -47.45] },
                            { nome: 'RA de Presidente Prudente', ratio: 4.7, densOSM: 467.4, densDER: 100.0, coords: [-22.12, -51.39] },
                            { nome: 'RA de Franca', ratio: 4.5, densOSM: 587.4, densDER: 132.0, coords: [-20.53, -47.4] }
                        ];

                        const classify = (ratio) => {
                            if (ratio >= 6.6) return { color: '#e67e22', label: '6,6√ó ou mais' };
                            if (ratio >= 5) return { color: '#f1c40f', label: '5,0‚Äì6,5√ó' };
                            return { color: '#2ecc71', label: 'At√© 4,9√ó' };
                        };

                        const bounds = [];
                        raData.forEach(({ nome, ratio, densOSM, densDER, coords }) => {
                            const { color, label } = classify(ratio);
                            const radius = Math.min(22, Math.max(8, ratio * 2.2));
                            const marker = L.circleMarker(coords, {
                                radius,
                                color,
                                weight: 2,
                                fillColor: color,
                                fillOpacity: 0.7
                            }).addTo(map);

                            marker.bindPopup(`
                                <strong>${nome}</strong><br>
                                Dens. OSM: ${densOSM.toLocaleString('pt-BR')} km/1000km¬≤<br>
                                Dens. DER: ${densDER.toLocaleString('pt-BR')} km/1000km¬≤<br>
                                Raz√£o OSM/DER: <strong>${ratio.toLocaleString('pt-BR')}√ó</strong><br>
                                Classifica√ß√£o: ${label}
                            `);

                            bounds.push(coords);
                        });

                        if (bounds.length) {
                            map.fitBounds(bounds, { padding: [20, 20] });
                        }

                        const legend = L.control({ position: 'bottomright' });
                        legend.onAdd = function () {
                            const div = L.DomUtil.create('div', 'legend');
                            div.innerHTML = `
                                <strong>Raz√£o OSM/DER</strong><br>
                                <div><span class="legend-color-box" style="background:#e67e22"></span> 6,6√ó ou mais</div>
                                <div><span class="legend-color-box" style="background:#f1c40f"></span> 5,0‚Äì6,5√ó</div>
                                <div><span class="legend-color-box" style="background:#2ecc71"></span> At√© 4,9√ó</div>
                                <small>Circulo proporcional √† raz√£o</small>
                            `;
                            return div;
                        };
                        legend.addTo(map);
                    }

                    document.addEventListener('DOMContentLoaded', initRADivergenciaMap);
                </script>

                <h3 class="section-subtitle mt-2">üìà Distribui√ß√£o das Diverg√™ncias:</h3>
                <div class="stats-container">
                    <div class="stat-box bg-green-light">
                        <span class="stat-label">Diverg√™ncia Moderada</span>
                        <span class="stat-value">2 <span class="stat-unit">(RAs)</span></span>
                        <span class="stat-info">Raz√£o OSM/DER: 4-5√ó</span>
                    </div>
                    <div class="stat-box bg-yellow-light">
                        <span class="stat-label">Diverg√™ncia Moderada-Alta</span>
                        <span class="stat-value">11 <span class="stat-unit">(RAs)</span></span>
                        <span class="stat-info">Raz√£o OSM/DER: 5-7√ó</span>
                    </div>
                    <div class="stat-box bg-orange-light">
                        <span class="stat-label">Diverg√™ncia Alta</span>
                        <span class="stat-value">3 <span class="stat-unit">(RAs)</span></span>
                        <span class="stat-info">Raz√£o OSM/DER: 7-9√ó</span>
                    </div>
                </div>

                <div class="alert alert-success">
                    <strong>‚úì Padr√£o Regional Consistente:</strong> Todas as regi√µes apresentam <strong>raz√£o OSM/DER entre 4,5√ó e 7,1√ó</strong>, indicando que a subnotifica√ß√£o do DER √© <strong>uniforme</strong> em todo o Estado, n√£o concentrada em regi√µes espec√≠ficas.
                </div>
            </div>

            <!-- TOP 10 MUNIC√çPIOS COMPARADOS -->
            <div class="section mt-2">
                <h2 class="section-title">Top 10 Munic√≠pios com Maior Diverg√™ncia OSM/DER</h2>
                <p class="section-subtitle">Munic√≠pios onde a malha OSM √© mais extensa em rela√ß√£o ao cadastro DER</p>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Posi√ß√£o</th>
                                <th>Munic√≠pio</th>
                                <th>RA</th>
                                <th>OSM (km)</th>
                                <th>DER (km)</th>
                                <th>Raz√£o</th>
                                <th>Classifica√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="bg-red-light">
                                <td>1</td>
                                <td><strong>Ituverava</strong></td>
                                <td>Franca</td>
                                <td>1.410,4</td>
                                <td>82,3</td>
                                <td><strong>17,1√ó</strong></td>
                                <td>üî¥ Cr√≠tica</td>
                            </tr>
                            <tr class="bg-red-light">
                                <td>2</td>
                                <td><strong>Ribeir√£o Preto</strong></td>
                                <td>Central</td>
                                <td>745,9</td>
                                <td>45,2</td>
                                <td><strong>16,5√ó</strong></td>
                                <td>üî¥ Cr√≠tica</td>
                            </tr>
                            <tr class="bg-red-light">
                                <td>3</td>
                                <td><strong>Mococa</strong></td>
                                <td>Campinas</td>
                                <td>798,6</td>
                                <td>54,3</td>
                                <td><strong>14,7√ó</strong></td>
                                <td>üî¥ Cr√≠tica</td>
                            </tr>
                            <tr class="bg-orange-light">
                                <td>4</td>
                                <td><strong>Casa Branca</strong></td>
                                <td>Campinas</td>
                                <td>892,5</td>
                                <td>68,9</td>
                                <td><strong>13,0√ó</strong></td>
                                <td>üü† Muito Alta</td>
                            </tr>
                            <tr class="bg-orange-light">
                                <td>5</td>
                                <td><strong>Barretos</strong></td>
                                <td>Barretos</td>
                                <td>769,4</td>
                                <td>62,8</td>
                                <td><strong>12,3√ó</strong></td>
                                <td>üü† Muito Alta</td>
                            </tr>
                            <tr class="bg-orange-light">
                                <td>6</td>
                                <td><strong>Bora</strong></td>
                                <td>Mar√≠lia</td>
                                <td>654,2</td>
                                <td>56,4</td>
                                <td><strong>11,6√ó</strong></td>
                                <td>üü† Muito Alta</td>
                            </tr>
                            <tr class="bg-orange-light">
                                <td>7</td>
                                <td><strong>Franca</strong></td>
                                <td>Franca</td>
                                <td>812,3</td>
                                <td>78,2</td>
                                <td><strong>10,4√ó</strong></td>
                                <td>üü† Muito Alta</td>
                            </tr>
                            <tr class="bg-orange-light">
                                <td>8</td>
                                <td><strong>Orl√¢ndia</strong></td>
                                <td>Franca</td>
                                <td>856,2</td>
                                <td>95,4</td>
                                <td><strong>9,0√ó</strong></td>
                                <td>üü† Alta</td>
                            </tr>
                            <tr class="bg-yellow-light">
                                <td>9</td>
                                <td><strong>S√£o Jo√£o da Boa Vista</strong></td>
                                <td>Campinas</td>
                                <td>782,1</td>
                                <td>91,7</td>
                                <td><strong>8,5√ó</strong></td>
                                <td>üü° Alta</td>
                            </tr>
                            <tr class="bg-yellow-light">
                                <td>10</td>
                                <td><strong>Araraquara</strong></td>
                                <td>Central</td>
                                <td>734,2</td>
                                <td>88,1</td>
                                <td><strong>8,3√ó</strong></td>
                                <td>üü° Alta</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="alert alert-danger">
                    <strong>üö® Munic√≠pios Cr√≠ticos:</strong> <strong>3 munic√≠pios</strong> (Ituverava, Ribeir√£o Preto, Mococa) apresentam <strong>diverg√™ncia >15√ó</strong>, indicando poss√≠vel <strong>aus√™ncia quase total</strong> de vicinais no cadastro DER apesar de extensa malha mapeada no OSM.
                </div>
            </div>

            <!-- S√çNTESE COMPARATIVA -->
            <div class="section mt-2">
                <h2 class="section-title">
                    <span class="icon icon-check"></span>
                    S√≠ntese da Compara√ß√£o OSM vs DER
                </h2>

                <div class="cards-grid">
                    <div class="card">
                        <h4 class="card-title">üìè Extens√£o</h4>
                        <div class="card-content">
                            <strong>OSM: 122.243 km</strong><br>
                            <strong>DER: 25.919 km</strong><br>
                            <span class="bg-red-light badge-inline">
                                <strong>Raz√£o: 4,7√ó</strong>
                            </span>
                        </div>
                    </div>
                    <div class="card">
                        <h4 class="card-title">üó∫Ô∏è Cobertura</h4>
                        <div class="card-content">
                            <strong>OSM:</strong> 645 munic√≠pios (100%)<br>
                            <strong>DER:</strong> 637 munic√≠pios (98,8%)<br>
                            <span class="bg-green-light badge-inline">
                                Cobertura similar
                            </span>
                        </div>
                    </div>
                    <div class="card">
                        <h4 class="card-title">üìä Variabilidade</h4>
                        <div class="card-content">
                            <strong>OSM:</strong> œÉ = 191,7 km<br>
                            <strong>DER:</strong> œÉ = 30,4 km<br>
                            <span class="bg-orange-light badge-inline">
                                <strong>OSM 6,3√ó mais vari√°vel</strong>
                            </span>
                        </div>
                    </div>
                </div>

                <h3 class="section-subtitle mt-2">üéØ Conclus√µes da Compara√ß√£o:</h3>
                <div class="section-content">
                    <ol class="list-spaced">
                        <li><strong>Subnotifica√ß√£o Sistem√°tica:</strong> DER registra apenas <strong>21% da malha vicinal real</strong> mapeada no OSM</li>
                        
                        <li><strong>Consist√™ncia Proporcional:</strong> Raz√£o OSM/DER de <strong>4,7√ó</strong> se mant√©m em todas as m√©tricas (extens√£o, densidade √°rea, densidade pop)</li>
                        
                        <li><strong>Uniformidade Regional:</strong> Todas as 16 RAs apresentam diverg√™ncia entre <strong>4,5√ó e 7,1√ó</strong>, sem outliers extremos</li>
                        
                        <li><strong>Munic√≠pios Cr√≠ticos:</strong> <strong>3 munic√≠pios</strong> com diverg√™ncia >15√ó necessitam revis√£o urgente do cadastro DER</li>
                        
                        <li><strong>Distribui√ß√£o Desigual DER:</strong> <strong>65% dos munic√≠pios</strong> t√™m <50 km cadastrados no DER vs apenas 13% no OSM</li>
                        
                        <li><strong>Valida√ß√£o Cruzada:</strong> Padr√£o regional similar (RMSP/Campinas altas, Registro baixa) valida ambas as fontes</li>
                        
                        <li><strong>Gap de Infraestrutura:</strong> <strong>96.324 km</strong> de vicinais OSM n√£o cadastradas oficialmente representam <strong>oportunidade</strong> para atualiza√ß√£o de dados e planejamento</li>
                    </ol>
                </div>

                <div class="alert alert-success mt-2">
                    <strong>‚úì Recomenda√ß√£o:</strong> OSM pode ser usado como <strong>fonte complementar confi√°vel</strong> para identificar malha vicinal existente e priorizar √°reas para levantamento de campo e atualiza√ß√£o do cadastro oficial DER/SP.
                </div>
            </div>
        </section>
            
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>M√©trica</th>
                            <th>OSM (Metodologia Principal)</th>
                            <th>OSM (Agregado)</th>
                            <th>DER</th>
                            <th>Raz√£o OSM/DER</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
    </main>

    <footer class="footer">
        <div class="footer-content">
            <p class="footer-text">Infer√™ncia Geoespacial Aplicada √† Gera√ß√£o de Base Vetorial Rodovi√°ria: Estudo de Caso para o Estado de S√£o Paulo | Janeiro 2026</p>
            <p class="footer-text">Dados: Malha municipal estimada - PLI/SP (OSM + DER/SP + SEADE/IBGE)</p>
        </div>
    </footer>

    <script src="../js/main.js"></script>
    <script>
        // Configura√ß√µes globais do Chart.js
        Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        Chart.defaults.font.size = 14;
        
        // Configura√ß√£o comum para legendas na parte inferior
        const legendConfig = {
            display: true,
            position: 'bottom',
            align: 'center',
            labels: {
                padding: 15,
                usePointStyle: true,
                font: { size: 12 }
            }
        };
        
        // Gr√°fico 1: Distribui√ß√£o OSM por Faixa de Extens√£o
        const ctxOSM = document.getElementById('chartDistribuicaoOSM');
        if (ctxOSM) {
            new Chart(ctxOSM.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['0-50 km', '50-100 km', '100-200 km', '200-400 km', '> 400 km'],
                    datasets: [{
                        label: 'N√∫mero de Munic√≠pios',
                        data: [85, 142, 198, 156, 64],
                        backgroundColor: 'rgba(0, 102, 204, 0.7)',
                        borderColor: 'rgba(0, 102, 204, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribui√ß√£o de Munic√≠pios por Faixa de Extens√£o - OSM',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: legendConfig,
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const extensoes = [3400, 10650, 29700, 46800, 31693];
                                    const percentuais = ['13.2%', '22.0%', '30.7%', '24.2%', '9.9%'];
                                    return [`Extens√£o: ~${extensoes[context.dataIndex].toLocaleString('pt-BR')} km`, 
                                            `Percentual: ${percentuais[context.dataIndex]}`];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Quantidade de Munic√≠pios' }
                        },
                        x: {
                            title: { display: true, text: 'Faixa de Extens√£o' }
                        }
                    }
                }
            });
        }

        // Gr√°fico 2: Distribui√ß√£o DER por Faixa
        const ctxDER = document.getElementById('chartDistribuicaoDER');
        if (ctxDER) {
            new Chart(ctxDER.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['0-50 km', '50-100 km', '100-200 km', '200-400 km', '> 400 km'],
                    datasets: [{
                        label: 'N√∫mero de Munic√≠pios',
                        data: [412, 158, 52, 14, 1],
                        backgroundColor: 'rgba(255, 102, 0, 0.7)',
                        borderColor: 'rgba(255, 102, 0, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribui√ß√£o de Munic√≠pios por Faixa de Extens√£o - DER',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: legendConfig,
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const extensoes = [12360, 11850, 7800, 4200, 409];
                                    const percentuais = ['64.7%', '24.8%', '8.2%', '2.2%', '0.2%'];
                                    return [`Extens√£o: ~${extensoes[context.dataIndex].toLocaleString('pt-BR')} km`, 
                                            `Percentual: ${percentuais[context.dataIndex]}`];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Quantidade de Munic√≠pios' }
                        },
                        x: {
                            title: { display: true, text: 'Faixa de Extens√£o' }
                        }
                    }
                }
            });
        }

        // Gr√°fico 3: Compara√ß√£o Geral OSM vs DER
        const ctxComp = document.getElementById('chartComparacaoGeral');
        if (ctxComp) {
            new Chart(ctxComp.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['Extens√£o Total (km)', 'Munic√≠pios', 'M√©dia/Munic√≠pio (km)', 'Densidade (km/10.000km¬≤)'],
                    datasets: [{
                        label: 'OSM',
                        data: [122243, 645, 189.5, 4920],
                        backgroundColor: 'rgba(0, 102, 204, 0.7)',
                        borderColor: 'rgba(0, 102, 204, 1)',
                        borderWidth: 2
                    }, {
                        label: 'DER',
                        data: [25919, 637, 40.7, 1040],
                        backgroundColor: 'rgba(255, 102, 0, 0.7)',
                        borderColor: 'rgba(255, 102, 0, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Compara√ß√£o de M√©tricas: OSM vs DER',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: legendConfig
                    },
                    scales: {
                        y: {
                            type: 'logarithmic',
                            title: { display: true, text: 'Valor (escala logar√≠tmica)' }
                        },
                        x: {
                            title: { display: true, text: 'M√©trica' }
                        }
                    }
                }
            });
        }

        // Gr√°fico 4: Distribui√ß√£o Comparada por Faixa
        const ctxCompFaixa = document.getElementById('chartDistribuicaoComparada');
        if (ctxCompFaixa) {
            new Chart(ctxCompFaixa.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['0-50 km', '50-100 km', '100-200 km', '200-400 km', '> 400 km'],
                    datasets: [{
                        label: 'OSM',
                        data: [85, 142, 198, 156, 64],
                        backgroundColor: 'rgba(0, 102, 204, 0.7)',
                        borderColor: 'rgba(0, 102, 204, 1)',
                        borderWidth: 2
                    }, {
                        label: 'DER',
                        data: [412, 158, 52, 14, 1],
                        backgroundColor: 'rgba(255, 102, 0, 0.7)',
                        borderColor: 'rgba(255, 102, 0, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Compara√ß√£o de Distribui√ß√£o por Faixa: OSM vs DER',
                            font: { size: 16, weight: 'bold' }
                        },
                        legend: legendConfig
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'N√∫mero de Munic√≠pios' }
                        },
                        x: {
                            title: { display: true, text: 'Faixa de Extens√£o' }
                        }
                    }
                }
            });
        }

        // Mapa Coropl√©tico de Densidade Regional
        const mapElement = document.getElementById('mapDensidadeRegional');
        if (mapElement) {
            const map = L.map('mapDensidadeRegional').setView([-22.5, -48.5], 7);
            
            const baseLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            // Dados de densidade por regi√£o (valores em km/10.000km¬≤)
            const densidadeRegional = {
                'RMSP': 10347,
                'RM de Campinas': 10014,
                'RA de Campinas': 8703,
                'RA de Sorocaba': 6200,
                'RA de S√£o Jos√© dos Campos': 5800,
                'RA de Ribeir√£o Preto': 5400,
                'RA de Bauru': 4900,
                'RA Central': 4500,
                'RA de Registro': 2597
            };

            // Fun√ß√£o para determinar cor baseada na densidade
            function getColor(densidade) {
                return densidade > 8000 ? '#006400' :
                       densidade > 6000 ? '#27ae60' :
                       densidade > 5000 ? '#f39c12' :
                       densidade > 4000 ? '#e67e22' :
                       densidade > 3000 ? '#d35400' :
                                         '#c0392b';
            }

            // Carregar e adicionar GeoJSON das regi√µes administrativas
            fetch('../data/regioes_administrativas_sp.geojson')
                .then(response => response.json())
                .then(data => {
                    const regioesLayer = L.geoJSON(data, {
                        style: function(feature) {
                            const regiao = feature.properties.nome || feature.properties.NOME;
                            const densidade = densidadeRegional[regiao] || 4920;
                            return {
                                fillColor: getColor(densidade),
                                weight: 2,
                                opacity: 1,
                                color: 'white',
                                fillOpacity: 0.7
                            };
                        },
                        onEachFeature: function(feature, layer) {
                            const regiao = feature.properties.nome || feature.properties.NOME;
                            const densidade = densidadeRegional[regiao] || 4920;
                            layer.bindPopup(`
                                <strong>${regiao}</strong><br>
                                Densidade: ${densidade.toLocaleString('pt-BR')} km/10.000km¬≤
                            `);
                        }
                    }).addTo(map);

                    const layerInfo = document.getElementById('mapDensidadeRegional-layer-info');
                    if (layerInfo) {
                        const legendPanel = document.createElement('div');
                        legendPanel.className = 'legend-panel';
                        legendPanel.innerHTML = `
                            <h4>Legenda Din√¢mica</h4>
                            <label>Camada
                                <select id="mapDensidadeRegional-legend-layer">
                                    <option value="regioes">Regi√µes Administrativas</option>
                                </select>
                            </label>
                            <label>Atributo
                                <select id="mapDensidadeRegional-legend-attr"></select>
                            </label>
                            <label>Tipo de dado
                                <select id="mapDensidadeRegional-legend-type">
                                    <option value="auto">Auto</option>
                                    <option value="text">Texto</option>
                                    <option value="numeric">Num√©rico</option>
                                </select>
                            </label>
                            <label>Legenda
                                <select id="mapDensidadeRegional-legend-mode">
                                    <option value="continuous">Cont√≠nua</option>
                                    <option value="discrete">Discreta</option>
                                </select>
                            </label>
                            <div class="legend-output" id="mapDensidadeRegional-legend-output"></div>
                        `;
                        layerInfo.appendChild(legendPanel);

                        const features = Array.isArray(regioesLayer.toGeoJSON().features)
                            ? regioesLayer.toGeoJSON().features
                            : [];
                        const attrSelect = legendPanel.querySelector('#mapDensidadeRegional-legend-attr');
                        const typeSelect = legendPanel.querySelector('#mapDensidadeRegional-legend-type');
                        const modeSelect = legendPanel.querySelector('#mapDensidadeRegional-legend-mode');
                        const output = legendPanel.querySelector('#mapDensidadeRegional-legend-output');

                        const attrs = new Set();
                        features.forEach(f => {
                            if (!f || !f.properties) return;
                            Object.keys(f.properties).forEach(k => attrs.add(k));
                        });
                        Array.from(attrs).sort((a, b) => a.localeCompare(b, 'pt-BR')).forEach(a => {
                            const opt = document.createElement('option');
                            opt.value = a;
                            opt.textContent = a;
                            attrSelect.appendChild(opt);
                        });

                        const inferType = (attr) => {
                            let numeric = 0;
                            let text = 0;
                            for (const f of features) {
                                const v = f?.properties?.[attr];
                                if (v === null || v === undefined || v === '') continue;
                                const n = Number(v);
                                if (!Number.isNaN(n) && Number.isFinite(n)) numeric += 1;
                                else text += 1;
                                if (numeric + text >= 20) break;
                            }
                            return numeric >= text ? 'numeric' : 'text';
                        };

                        const buildItems = (values, type, mode) => {
                            if (type === 'text') {
                                const unique = Array.from(new Set(values)).slice(0, 12);
                                return unique.map(val => ({
                                    label: String(val),
                                    color: `hsl(${Math.floor(Math.random() * 360)}, 65%, 55%)`
                                }));
                            }
                            const nums = values.map(v => Number(v)).filter(v => !Number.isNaN(v) && Number.isFinite(v));
                            if (!nums.length) return [];
                            const min = Math.min(...nums);
                            const max = Math.max(...nums);
                            const steps = 5;
                            const ramp = ['#4575b4', '#91bfdb', '#e0f3f8', '#fee090', '#fc8d59'];
                            const items = [];
                            for (let i = 0; i < steps; i += 1) {
                                const from = min + (i * (max - min)) / steps;
                                const to = min + ((i + 1) * (max - min)) / steps;
                                items.push({
                                    label: `${from.toLocaleString('pt-BR', {maximumFractionDigits: 2})} ‚Äì ${to.toLocaleString('pt-BR', {maximumFractionDigits: 2})}`,
                                    color: mode === 'discrete'
                                        ? `hsl(${Math.floor(Math.random() * 360)}, 65%, 55%)`
                                        : ramp[i % ramp.length]
                                });
                            }
                            return items;
                        };

                        const renderLegend = () => {
                            output.innerHTML = '';
                            const attr = attrSelect.value;
                            const values = features.map(f => f?.properties?.[attr]).filter(v => v !== undefined && v !== null && v !== '');
                            const type = typeSelect.value === 'auto' ? inferType(attr) : typeSelect.value;
                            const mode = modeSelect.value;
                            const items = buildItems(values, type, mode);
                            if (!items.length) {
                                output.innerHTML = '<p>Sem valores suficientes para legenda.</p>';
                                return;
                            }
                            const list = document.createElement('ul');
                            list.className = 'legend-list';
                            items.forEach(item => {
                                const li = document.createElement('li');
                                li.className = 'legend-item';
                                const swatch = document.createElement('span');
                                swatch.className = 'legend-swatch';
                                swatch.style.backgroundColor = item.color;
                                const label = document.createElement('span');
                                label.textContent = item.label;
                                li.appendChild(swatch);
                                li.appendChild(label);
                                list.appendChild(li);
                            });
                            output.appendChild(list);
                        };

                        attrSelect.addEventListener('change', renderLegend);
                        typeSelect.addEventListener('change', renderLegend);
                        modeSelect.addEventListener('change', renderLegend);
                        renderLegend();
                    }
                })
                .catch(err => console.error('Erro ao carregar GeoJSON:', err));
        }
